# Lemon Squeezy ê²°ì œ ì‹œìŠ¤í…œ êµ¬í˜„ ë°©ì•ˆ

## ğŸ“‹ ê°œìš”

Lemon Squeezyë¥¼ ì‚¬ìš©í•˜ì—¬ Valityì˜ ìš”ê¸ˆì œ ì‹œìŠ¤í…œì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

**ì°¸ê³ **: [Lemon Squeezy API ë¬¸ì„œ](https://docs.lemonsqueezy.com/api)

---

## ğŸ›’ Lemon Squeezy Product ë“±ë¡ (í•„ìˆ˜)

### âš ï¸ ì¤‘ìš”: Product ë“±ë¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤

Lemon Squeezyë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ **ë°˜ë“œì‹œ** ë‹¤ìŒì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤:

1. **Store ìƒì„±** (ìµœì´ˆ 1íšŒ)
2. **Product ìƒì„±** (ê° í”Œëœ/ì• ë“œì˜¨ë§ˆë‹¤)
3. **Variant ìƒì„±** (ê°€ê²©ë³„)
4. **API Key ìƒì„±**

---

## ğŸ“¦ Product ë“±ë¡ ì „ëµ

### ì „ëµ 1: í”Œëœë³„ Product ìƒì„± (ê¶Œì¥)

ê° í”Œëœì„ ë³„ë„ Productë¡œ ìƒì„±:

| Product ì´ë¦„ | Variant | ê°€ê²© | ì„¤ëª… |
|-------------|---------|------|------|
| Vality Free | Free Plan | $0/ì›” | ë¬´ë£Œ í”Œëœ |
| Vality Paid Tier 1 | 1,001-5,000í†µ | $9/ì›” | ê¸°ë³¸ ìœ ë£Œ í”Œëœ |
| Vality Paid Tier 2 | 5,001-10,000í†µ | $19/ì›” | ì¤‘ê¸‰ í”Œëœ |
| Vality Paid Tier 3 | 10,001-50,000í†µ | $39/ì›” | ê³ ê¸‰ í”Œëœ |
| Vality Paid Tier 4 | 50,001-100,000í†µ | $79/ì›” | í”„ë¦¬ë¯¸ì—„ í”Œëœ |

**ì¥ì :**
- ê° í”Œëœì„ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬ ê°€ëŠ¥
- í”Œëœë³„ í†µê³„ ì¶”ì  ìš©ì´
- ì—…ê·¸ë ˆì´ë“œ/ë‹¤ìš´ê·¸ë ˆì´ë“œ ì‹œ Variantë§Œ ë³€ê²½

### ì „ëµ 2: ë‹¨ì¼ Product + ì—¬ëŸ¬ Variant (ëŒ€ì•ˆ)

í•˜ë‚˜ì˜ Productì— ì—¬ëŸ¬ Variant ìƒì„±:

| Product ì´ë¦„ | Variant | ê°€ê²© |
|-------------|---------|------|
| Vality Subscription | Free | $0/ì›” |
| Vality Subscription | Tier 1 | $9/ì›” |
| Vality Subscription | Tier 2 | $19/ì›” |
| Vality Subscription | Tier 3 | $39/ì›” |
| Vality Subscription | Tier 4 | $79/ì›” |

---

## ğŸ”Œ ì• ë“œì˜¨ Product ì„¤ì •

ê° ì• ë“œì˜¨ì„ ë³„ë„ Productë¡œ ìƒì„± (ê¶Œì¥):

| Product ì´ë¦„ | Variant | ê°€ê²© | ì„¤ëª… |
|-------------|---------|------|------|
| ì˜ˆì•½ ë°œì†¡ | Monthly | $9/ì›” | ì˜ˆì•½ ë°œì†¡ ê¸°ëŠ¥ |
| ê³ ê¸‰ ë¶„ì„ | Monthly | $9/ì›” | ê³ ê¸‰ ë¶„ì„ ê¸°ëŠ¥ |
| ì—¬ëŸ¬ ë‰´ìŠ¤ë ˆí„° | Monthly | $9/ì›” | ì—¬ëŸ¬ ë‰´ìŠ¤ë ˆí„° ìƒì„± |
| íƒœê¹… & ì„¸ê·¸ë¨¼íŠ¸ | Monthly | $9/ì›” | íƒœê¹… ë° ì„¸ê·¸ë¨¼íŠ¸ ê´€ë¦¬ |
| ìë™í™” | Monthly | $29/ì›” | ìë™í™” ì›Œí¬í”Œë¡œìš° |
| í™”ì´íŠ¸ë¼ë²¨ë§ | Monthly | $79/ì›” | í™”ì´íŠ¸ë¼ë²¨ë§ |

---

## ğŸª Lemon Squeezy ì„¤ì • ë‹¨ê³„

### 1. Store ìƒì„±

1. Lemon Squeezy ëŒ€ì‹œë³´ë“œ ì ‘ì†
2. "Stores" â†’ "Create Store"
3. Store ì´ë¦„, ë„ë©”ì¸ ë“± ì„¤ì •
4. Store ID ê¸°ë¡ (APIì—ì„œ ì‚¬ìš©)

### 2. Product ìƒì„±

**ë°©ë²• A: ëŒ€ì‹œë³´ë“œì—ì„œ ìƒì„±**

1. "Products" â†’ "Create Product"
2. Product ì´ë¦„ ì…ë ¥ (ì˜ˆ: "Vality Paid Tier 1")
3. Product ì„¤ëª… ì…ë ¥
4. "Create Product" í´ë¦­

**ë°©ë²• B: APIë¡œ ìƒì„±**

```kotlin
// Product ìƒì„±
POST https://api.lemonsqueezy.com/v1/products
{
  "data": {
    "type": "products",
    "attributes": {
      "name": "Vality Paid Tier 1",
      "description": "1,001-5,000í†µ ë°œì†¡ í”Œëœ",
      "status": "published"
    },
    "relationships": {
      "store": {
        "data": {
          "type": "stores",
          "id": "STORE_ID"
        }
      }
    }
  }
}
```

### 3. Variant ìƒì„±

ê° Productì— ëŒ€í•´ Variant ìƒì„±:

```kotlin
// Variant ìƒì„±
POST https://api.lemonsqueezy.com/v1/variants
{
  "data": {
    "type": "variants",
    "attributes": {
      "name": "Monthly",
      "price": 900, // $9 (ì„¼íŠ¸ ë‹¨ìœ„)
      "interval": "month", // ì›”ê°„ êµ¬ë…
      "interval_count": 1,
      "is_usage_based": false
    },
    "relationships": {
      "product": {
        "data": {
          "type": "products",
          "id": "PRODUCT_ID"
        }
      }
    }
  }
}
```

### 4. API Key ìƒì„±

1. "Settings" â†’ "API"
2. "Create API Key" í´ë¦­
3. API Key ë³µì‚¬ ë° ì•ˆì „í•˜ê²Œ ë³´ê´€
4. í™˜ê²½ ë³€ìˆ˜ì— ì €ì¥

---

## ğŸ”‘ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

```env
# Lemon Squeezy ì„¤ì •
LEMON_SQUEEZY_API_KEY=your_api_key_here
LEMON_SQUEEZY_STORE_ID=your_store_id_here

# Product IDs (í”Œëœë³„)
LEMON_SQUEEZY_PRODUCT_ID_FREE=product_id_for_free
LEMON_SQUEEZY_PRODUCT_ID_TIER_1=product_id_for_tier_1
LEMON_SQUEEZY_PRODUCT_ID_TIER_2=product_id_for_tier_2
LEMON_SQUEEZY_PRODUCT_ID_TIER_3=product_id_for_tier_3
LEMON_SQUEEZY_PRODUCT_ID_TIER_4=product_id_for_tier_4

# Variant IDs (í”Œëœë³„)
LEMON_SQUEEZY_VARIANT_ID_FREE=variant_id_for_free
LEMON_SQUEEZY_VARIANT_ID_TIER_1=variant_id_for_tier_1
LEMON_SQUEEZY_VARIANT_ID_TIER_2=variant_id_for_tier_2
LEMON_SQUEEZY_VARIANT_ID_TIER_3=variant_id_for_tier_3
LEMON_SQUEEZY_VARIANT_ID_TIER_4=variant_id_for_tier_4

# Add-on Product IDs
LEMON_SQUEEZY_PRODUCT_ID_ADDON_SCHEDULED_SENDING=product_id_for_scheduled_sending
LEMON_SQUEEZY_PRODUCT_ID_ADDON_ADVANCED_ANALYTICS=product_id_for_advanced_analytics
LEMON_SQUEEZY_PRODUCT_ID_ADDON_MULTIPLE_NEWSLETTERS=product_id_for_multiple_newsletters
# ... ê¸°íƒ€ ì• ë“œì˜¨ë“¤

# Add-on Variant IDs
LEMON_SQUEEZY_VARIANT_ID_ADDON_SCHEDULED_SENDING=variant_id_for_scheduled_sending
LEMON_SQUEEZY_VARIANT_ID_ADDON_ADVANCED_ANALYTICS=variant_id_for_advanced_analytics
# ... ê¸°íƒ€ ì• ë“œì˜¨ë“¤

# Webhook Secret
LEMON_SQUEEZY_WEBHOOK_SECRET=your_webhook_secret_here
```

---

## ğŸ“‹ Product/Variant ë§¤í•‘ í…Œì´ë¸”

ë°ì´í„°ë² ì´ìŠ¤ì— Product/Variant IDë¥¼ ì €ì¥í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤:

```sql
-- Product/Variant ë§¤í•‘ í…Œì´ë¸”
CREATE TABLE lemon_squeezy_products (
    id VARCHAR(25) PRIMARY KEY,
    product_type VARCHAR(50) NOT NULL,
    -- 'PLAN_FREE' | 'PLAN_TIER_1' | 'PLAN_TIER_2' | 'ADDON_SCHEDULED_SENDING' | ...
    lemon_squeezy_product_id VARCHAR(255) NOT NULL UNIQUE,
    lemon_squeezy_variant_id VARCHAR(255) NOT NULL UNIQUE,
    price INTEGER NOT NULL, -- ì„¼íŠ¸ ë‹¨ìœ„
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- ì´ˆê¸° ë°ì´í„° ì‚½ì…
INSERT INTO lemon_squeezy_products (id, product_type, lemon_squeezy_product_id, lemon_squeezy_variant_id, price, name) VALUES
('prod_free', 'PLAN_FREE', 'LS_PRODUCT_ID_FREE', 'LS_VARIANT_ID_FREE', 0, 'Free Plan'),
('prod_tier1', 'PLAN_TIER_1', 'LS_PRODUCT_ID_TIER_1', 'LS_VARIANT_ID_TIER_1', 900, 'Paid Tier 1'),
('prod_tier2', 'PLAN_TIER_2', 'LS_PRODUCT_ID_TIER_2', 'LS_VARIANT_ID_TIER_2', 1900, 'Paid Tier 2'),
('prod_tier3', 'PLAN_TIER_3', 'LS_PRODUCT_ID_TIER_3', 'LS_VARIANT_ID_TIER_3', 3900, 'Paid Tier 3'),
('prod_tier4', 'PLAN_TIER_4', 'LS_PRODUCT_ID_TIER_4', 'LS_VARIANT_ID_TIER_4', 7900, 'Paid Tier 4'),
('addon_scheduled', 'ADDON_SCHEDULED_SENDING', 'LS_PRODUCT_ID_ADDON_SCHEDULED', 'LS_VARIANT_ID_ADDON_SCHEDULED', 900, 'ì˜ˆì•½ ë°œì†¡'),
('addon_analytics', 'ADDON_ADVANCED_ANALYTICS', 'LS_PRODUCT_ID_ADDON_ANALYTICS', 'LS_VARIANT_ID_ADDON_ANALYTICS', 900, 'ê³ ê¸‰ ë¶„ì„');
-- ... ê¸°íƒ€ ì• ë“œì˜¨ë“¤
```

---

## ğŸ’³ Free í”Œëœê³¼ ê²°ì œ ì •ë³´

### âš ï¸ ì¤‘ìš”: Free í”Œëœì€ ê²°ì œ ì •ë³´ ì—†ì´ ì‹œì‘ ê°€ëŠ¥

**Free í”Œëœ ($0/ì›”)ì˜ ê²½ìš°:**
- âœ… **ê²°ì œ ì •ë³´ ì…ë ¥ ë¶ˆí•„ìš”** - $0 ê°€ê²©ì´ë¯€ë¡œ ê²°ì œ ìˆ˜ë‹¨ì´ í•„ìš” ì—†ìŒ
- âœ… ì‚¬ìš©ìëŠ” ì¦‰ì‹œ Free í”Œëœìœ¼ë¡œ ì‹œì‘ ê°€ëŠ¥
- âœ… Lemon Squeezyì—ì„œ $0 Product/VariantëŠ” Checkout ì—†ì´ Subscription ìƒì„± ê°€ëŠ¥

**Free â†’ Paid ì „í™˜ ì‹œ:**
- 1,000í†µ ì´ˆê³¼ ì‹œ ì—…ê·¸ë ˆì´ë“œ í•„ìš”
- ì´ë•Œ **ì²˜ìŒìœ¼ë¡œ ê²°ì œ ì •ë³´ ì…ë ¥ ìš”êµ¬**
- Checkout í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì—¬ ê²°ì œ ì •ë³´ ì…ë ¥ í›„ ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ

---

## âœ… êµ¬í˜„ ê°€ëŠ¥í•œ ì‹œë‚˜ë¦¬ì˜¤

### 1. ê¸°ë³¸ í”Œëœ($9/ì›”) ì‚¬ìš© ì¤‘ ì• ë“œì˜¨ ì¶”ê°€

**êµ¬í˜„ ë°©ë²•:**
- Lemon Squeezyì˜ **Subscription Update API**ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬ë…ì— Line Items(ì• ë“œì˜¨) ì¶”ê°€
- ìë™ìœ¼ë¡œ **Proration(ë¹„ë¡€ ë°°ë¶„)** ì²˜ë¦¬ë¨
- ë‹¤ìŒ ì²­êµ¬ì¼ì— ì¶”ê°€ ìš”ê¸ˆì´ ë°˜ì˜ë¨
- **ê²°ì œ ì •ë³´ëŠ” ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì¶”ê°€ ì…ë ¥ ë¶ˆí•„ìš”**

### 2. Free í”Œëœ ì‚¬ìš© ì¤‘ ì›” ë°œì†¡ëŸ‰ 1,000í†µ ì´ˆê³¼ ì‹œ Paid í”Œëœìœ¼ë¡œ ì „í™˜

**êµ¬í˜„ ë°©ë²•:**
- **Usage-based Billing** ë˜ëŠ” **Subscription Upgrade API** ì‚¬ìš©
- ì›”ê°„ ë°œì†¡ëŸ‰ ëª¨ë‹ˆí„°ë§ í›„ ìë™ ì—…ê·¸ë ˆì´ë“œ
- **1,000í†µ ì´ˆê³¼ ì‹œ Checkout í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì—¬ ê²°ì œ ì •ë³´ ì…ë ¥ ìš”êµ¬**
- ê²°ì œ ì •ë³´ ì…ë ¥ í›„ Subscription ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ
- ì›¹í›…ì„ í†µí•œ ìë™ ì²˜ë¦¬ ê°€ëŠ¥

---

## ğŸ”§ êµ¬í˜„ ìƒì„¸

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì• ë“œì˜¨ ì¶”ê°€

#### ë°©ë²• A: Subscription Update API (ê¶Œì¥)

```kotlin
// Lemon Squeezy APIë¥¼ í†µí•œ ì• ë“œì˜¨ ì¶”ê°€
suspend fun addAddonToSubscription(
    subscriptionId: String,
    addonProductId: String,
    addonVariantId: String
): Subscription {
    val response = httpClient.patch("https://api.lemonsqueezy.com/v1/subscriptions/$subscriptionId") {
        header("Authorization", "Bearer $apiKey")
        header("Content-Type", "application/vnd.api+json")
        setBody(buildJsonObject {
            put("data", buildJsonObject {
                put("type", "subscriptions")
                put("id", subscriptionId)
                put("attributes", buildJsonObject {
                    put("product_id", addonProductId)
                    put("variant_id", addonVariantId)
                })
            })
        })
    }
    
    // Prorationì´ ìë™ìœ¼ë¡œ ê³„ì‚°ë˜ì–´ ë‹¤ìŒ ì²­êµ¬ì¼ì— ë°˜ì˜ë¨
    return parseSubscriptionResponse(response)
}
```

#### ë°©ë²• B: Line Items ì‚¬ìš© (ë” ìœ ì—°í•¨)

Lemon SqueezyëŠ” Subscriptionì— Line Itemsë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```kotlin
// Subscriptionì— Line Item ì¶”ê°€
suspend fun addLineItemToSubscription(
    subscriptionId: String,
    addonPrice: Int // ì„¼íŠ¸ ë‹¨ìœ„ (ì˜ˆ: $9 = 900)
): Subscription {
    // Subscription ì—…ë°ì´íŠ¸ ì‹œ line_items ì¶”ê°€
    val response = httpClient.patch("https://api.lemonsqueezy.com/v1/subscriptions/$subscriptionId") {
        header("Authorization", "Bearer $apiKey")
        setBody(buildJsonObject {
            put("data", buildJsonObject {
                put("type", "subscriptions")
                put("id", subscriptionId)
                put("attributes", buildJsonObject {
                    put("custom_price", null) // ê¸°ë³¸ ê°€ê²© ìœ ì§€
                    put("line_items", buildJsonArray {
                        add(buildJsonObject {
                            put("name", "ì˜ˆì•½ ë°œì†¡ ì• ë“œì˜¨")
                            put("price", addonPrice)
                            put("quantity", 1)
                        })
                    })
                })
            })
        })
    }
    
    return parseSubscriptionResponse(response)
}
```

**ì¥ì :**
- âœ… ìë™ Proration ì²˜ë¦¬
- âœ… ë‹¤ìŒ ì²­êµ¬ì¼ì— ìë™ ë°˜ì˜
- âœ… ì‚¬ìš©ìê°€ ë³„ë„ ê²°ì œí•  í•„ìš” ì—†ìŒ

**ì£¼ì˜ì‚¬í•­:**
- Line ItemsëŠ” Subscription ì—…ë°ì´íŠ¸ ì‹œì—ë§Œ ì¶”ê°€ ê°€ëŠ¥
- ê° ì• ë“œì˜¨ì„ ë³„ë„ Product/Variantë¡œ ìƒì„±í•˜ëŠ” ê²ƒì´ ë” ê´€ë¦¬í•˜ê¸° ì‰¬ì›€

---

### ì‹œë‚˜ë¦¬ì˜¤ 2: Free â†’ Paid í”Œëœ ìë™ ì „í™˜

#### ë°©ë²• A: Usage-based Billing (Lemon Squeezy ë„¤ì´í‹°ë¸Œ)

Lemon SqueezyëŠ” Usage-based Billingì„ ì§€ì›í•˜ì§€ë§Œ, ì œí•œì ì…ë‹ˆë‹¤.

**êµ¬í˜„ ë°©ì‹:**
1. **Usage Records API**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì›”ê°„ ë°œì†¡ëŸ‰ ì¶”ì 
2. 1,000í†µ ì´ˆê³¼ ì‹œ ìë™ìœ¼ë¡œ Subscription ì—…ê·¸ë ˆì´ë“œ

```kotlin
// ì›”ê°„ ë°œì†¡ëŸ‰ ì¶”ì  ë° ìë™ ì—…ê·¸ë ˆì´ë“œ
suspend fun checkAndUpgradeSubscription(userId: String) {
    val monthlyEmailCount = getMonthlyEmailCount(userId)
    
    if (monthlyEmailCount > 1000) {
        val subscription = getSubscriptionByUserId(userId)
        
        if (subscription?.planType == "FREE") {
            // Paid í”Œëœìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ
            upgradeSubscription(
                subscriptionId = subscription.id,
                newVariantId = PAID_PLAN_VARIANT_ID
            )
        }
    }
}
```

#### ë°©ë²• B: ë°±ì—”ë“œì—ì„œ ëª¨ë‹ˆí„°ë§ í›„ ìˆ˜ë™ ì—…ê·¸ë ˆì´ë“œ (ê¶Œì¥)

**êµ¬í˜„ ë°©ì‹:**
1. ë§¤ì¼ ë˜ëŠ” ì‹¤ì‹œê°„ìœ¼ë¡œ ì›”ê°„ ë°œì†¡ëŸ‰ ëª¨ë‹ˆí„°ë§
2. 1,000í†µ ì´ˆê³¼ ì‹œ Subscription ì—…ê·¸ë ˆì´ë“œ API í˜¸ì¶œ
3. ì›¹í›…ì„ í†µí•´ ê²°ì œ ì²˜ë¦¬ í™•ì¸

```kotlin
// ë°œì†¡ëŸ‰ ëª¨ë‹ˆí„°ë§ ë° ìë™ ì—…ê·¸ë ˆì´ë“œ
class SubscriptionUpgradeService(
    private val emailLogRepository: EmailLogRepository,
    private val subscriptionRepository: SubscriptionRepository,
    private val lemonSqueezyClient: LemonSqueezyClient
) {
    /**
     * ì›”ê°„ ë°œì†¡ëŸ‰ í™•ì¸ ë° ìë™ ì—…ê·¸ë ˆì´ë“œ
     */
    suspend fun checkMonthlyUsageAndUpgrade(userId: String) {
        val currentMonth = LocalDate.now().withDayOfMonth(1)
        val monthlyEmailCount = emailLogRepository.countByUserIdAndMonth(
            userId = userId,
            month = currentMonth
        )
        
        val subscription = subscriptionRepository.findByUserId(userId)
            ?: return // êµ¬ë…ì´ ì—†ìœ¼ë©´ ë¬´ì‹œ
        
        // Free í”Œëœì´ê³  1,000í†µ ì´ˆê³¼ ì‹œ
        if (subscription.planType == PlanType.FREE && monthlyEmailCount > 1000) {
            // ì ì ˆí•œ Paid í”Œëœ ì„ íƒ (ë°œì†¡ëŸ‰ì— ë”°ë¼)
            val newPlanType = determinePlanType(monthlyEmailCount)
            
            // ê²°ì œ ì •ë³´ê°€ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            val hasPaymentMethod = lemonSqueezyClient.hasPaymentMethod(
                customerId = getCustomerId(userId)
            )
            
            if (hasPaymentMethod) {
                // ê²°ì œ ì •ë³´ê°€ ìˆìœ¼ë©´ ìë™ ì—…ê·¸ë ˆì´ë“œ
                val updatedSubscription = lemonSqueezyClient.upgradeSubscription(
                    subscriptionId = subscription.lemonSqueezySubscriptionId,
                    newVariantId = getVariantIdForPlan(newPlanType)
                )
                
                // DB ì—…ë°ì´íŠ¸
                subscriptionRepository.update(
                    subscription.copy(
                        planType = newPlanType,
                        lemonSqueezySubscriptionId = updatedSubscription.id
                    )
                )
                
                // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                sendUpgradeNotification(userId, newPlanType)
            } else {
                // ê²°ì œ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì—…ê·¸ë ˆì´ë“œ ìš”ì²­ ì•Œë¦¼ë§Œ ë°œì†¡
                // ì‚¬ìš©ìê°€ ì§ì ‘ ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ Checkout í˜ì´ì§€ë¡œ ì´ë™
                sendUpgradeRequiredNotification(userId, newPlanType, monthlyEmailCount)
            }
        }
    }
    
    private fun determinePlanType(emailCount: Long): PlanType {
        return when {
            emailCount <= 1000 -> PlanType.FREE
            emailCount <= 5000 -> PlanType.PAID_TIER_1 // $9/ì›”
            emailCount <= 10000 -> PlanType.PAID_TIER_2 // $19/ì›”
            emailCount <= 50000 -> PlanType.PAID_TIER_3 // $39/ì›”
            emailCount <= 100000 -> PlanType.PAID_TIER_4 // $79/ì›”
            else -> PlanType.CUSTOM
        }
    }
}
```

**ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§:**
```kotlin
// ì´ë©”ì¼ ë°œì†¡ ì‹œ ë°œì†¡ëŸ‰ ì²´í¬
suspend fun sendIssueEmail(issueId: String) {
    // ì´ë©”ì¼ ë°œì†¡ ë¡œì§...
    
    // ë°œì†¡ í›„ ë°œì†¡ëŸ‰ ì²´í¬
    val userId = getUserIdFromIssue(issueId)
    subscriptionUpgradeService.checkMonthlyUsageAndUpgrade(userId)
}
```

**ë°°ì¹˜ ì‘ì—… (ë§¤ì¼ ì‹¤í–‰):**
```kotlin
// ë§¤ì¼ ìì •ì— ëª¨ë“  ì‚¬ìš©ìì˜ ë°œì†¡ëŸ‰ ì²´í¬
@Scheduled(fixedRate = 86400000) // 24ì‹œê°„ë§ˆë‹¤
suspend fun checkAllUsersUsage() {
    val allUsers = userRepository.findAll()
    
    allUsers.forEach { user ->
        subscriptionUpgradeService.checkMonthlyUsageAndUpgrade(user.id)
    }
}
```

---

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### Subscription í…Œì´ë¸”

```sql
CREATE TABLE subscriptions (
    id VARCHAR(25) PRIMARY KEY,
    user_id VARCHAR(25) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    plan_type VARCHAR(20) NOT NULL DEFAULT 'FREE',
    -- 'FREE' | 'PAID_TIER_1' | 'PAID_TIER_2' | 'PAID_TIER_3' | 'PAID_TIER_4' | 'CUSTOM'
    lemon_squeezy_subscription_id VARCHAR(255) UNIQUE,
    lemon_squeezy_variant_id VARCHAR(255), -- í˜„ì¬ í”Œëœì˜ Variant ID
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    -- 'ACTIVE' | 'CANCELED' | 'PAST_DUE' | 'EXPIRED'
    current_period_start TIMESTAMP NOT NULL,
    current_period_end TIMESTAMP NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    UNIQUE(user_id)
);
```

### Subscription Addons í…Œì´ë¸”

```sql
CREATE TABLE subscription_addons (
    id VARCHAR(25) PRIMARY KEY,
    subscription_id VARCHAR(25) NOT NULL REFERENCES subscriptions(id) ON DELETE CASCADE,
    addon_type VARCHAR(50) NOT NULL,
    -- 'SCHEDULED_SENDING' | 'ADVANCED_ANALYTICS' | 'MULTIPLE_NEWSLETTERS' ë“±
    lemon_squeezy_product_id VARCHAR(255),
    lemon_squeezy_variant_id VARCHAR(255),
    price INTEGER NOT NULL, -- ì„¼íŠ¸ ë‹¨ìœ„
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    -- 'ACTIVE' | 'CANCELED'
    added_at TIMESTAMP NOT NULL DEFAULT NOW(),
    canceled_at TIMESTAMP NULL
);

CREATE INDEX idx_subscription_addons_subscription_id ON subscription_addons(subscription_id);
CREATE INDEX idx_subscription_addons_status ON subscription_addons(status);
```

---

## ğŸ”„ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì• ë“œì˜¨ ì¶”ê°€ í”Œë¡œìš°

```
[ì‚¬ìš©ì] â†’ [í”„ë¡ íŠ¸ì—”ë“œ] â†’ [ë°±ì—”ë“œ API] â†’ [Lemon Squeezy]
   â†“
1. ì‚¬ìš©ìê°€ "ì˜ˆì•½ ë°œì†¡" ì• ë“œì˜¨ ì¶”ê°€ í´ë¦­
   â†“
2. POST /api/subscriptions/addons
   {
     "addonType": "SCHEDULED_SENDING",
     "subscriptionId": "sub_xxx"
   }
   â†“
3. ë°±ì—”ë“œì—ì„œ:
   - Subscriptionì— Line Item ì¶”ê°€ ë˜ëŠ”
   - Subscription Update API í˜¸ì¶œ
   â†“
4. Lemon Squeezyì—ì„œ:
   - Proration ê³„ì‚°
   - ë‹¤ìŒ ì²­êµ¬ì¼ì— ì¶”ê°€ ìš”ê¸ˆ ë°˜ì˜
   â†“
5. ì›¹í›… ìˆ˜ì‹ :
   - subscription.updated ì´ë²¤íŠ¸
   - DB ì—…ë°ì´íŠ¸
   â†“
6. ì‚¬ìš©ìì—ê²Œ í™•ì¸ ë©”ì‹œì§€ í‘œì‹œ
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: Free â†’ Paid ìë™ ì „í™˜ í”Œë¡œìš°

```
[ì´ë©”ì¼ ë°œì†¡] â†’ [ë°œì†¡ëŸ‰ ì²´í¬] â†’ [ê²°ì œ ì •ë³´ ì…ë ¥ ìš”êµ¬] â†’ [ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ]
   â†“
1. ì´ìŠˆ ë°œí–‰ ì‹œ ì´ë©”ì¼ ë°œì†¡
   â†“
2. EmailLogì— ë°œì†¡ ê¸°ë¡ ì €ì¥
   â†“
3. ë°œì†¡ í›„ ë°œì†¡ëŸ‰ ì²´í¬:
   - ì›”ê°„ ë°œì†¡ëŸ‰ ì¡°íšŒ
   - 1,000í†µ ì´ˆê³¼ í™•ì¸
   â†“
4. Free í”Œëœì¸ ê²½ìš°:
   - ì ì ˆí•œ Paid í”Œëœ ê²°ì •
   - ì‚¬ìš©ìì—ê²Œ ì—…ê·¸ë ˆì´ë“œ ì•Œë¦¼ í‘œì‹œ
   - "ì—…ê·¸ë ˆì´ë“œ" ë²„íŠ¼ í´ë¦­ ì‹œ Checkout í˜ì´ì§€ë¡œ ì´ë™
   â†“
5. Checkout í˜ì´ì§€:
   - ê²°ì œ ì •ë³´ ì…ë ¥ (ì¹´ë“œ ë“±)
   - ê²°ì œ ì™„ë£Œ
   â†“
6. Lemon Squeezyì—ì„œ:
   - Subscription ìƒì„±/ì—…ê·¸ë ˆì´ë“œ
   - ê²°ì œ ì²˜ë¦¬
   â†“
7. ì›¹í›… ìˆ˜ì‹ :
   - subscription.created ë˜ëŠ” subscription.updated ì´ë²¤íŠ¸
   - DB ì—…ë°ì´íŠ¸
   â†“
8. ì‚¬ìš©ìì—ê²Œ ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ ì•Œë¦¼
```

**ë˜ëŠ” ìë™ ì—…ê·¸ë ˆì´ë“œ (ê²°ì œ ì •ë³´ ë¯¸ë¦¬ ë“±ë¡ëœ ê²½ìš°):**

```
[ì´ë©”ì¼ ë°œì†¡] â†’ [ë°œì†¡ëŸ‰ ì²´í¬] â†’ [ìë™ ì—…ê·¸ë ˆì´ë“œ]
   â†“
1-3. ë™ì¼
   â†“
4. Free í”Œëœì´ì§€ë§Œ ê²°ì œ ì •ë³´ê°€ ì´ë¯¸ ë“±ë¡ëœ ê²½ìš°:
   - ìë™ìœ¼ë¡œ Subscription ì—…ê·¸ë ˆì´ë“œ
   - ì¦‰ì‹œ ê²°ì œ ì²˜ë¦¬
   â†“
5-8. ë™ì¼
```

---

## ğŸ› ï¸ API ì—”ë“œí¬ì¸íŠ¸

### 1. ì• ë“œì˜¨ ì¶”ê°€

```kotlin
POST /api/subscriptions/addons
{
  "addonType": "SCHEDULED_SENDING" | "ADVANCED_ANALYTICS" | ...
}

Response:
{
  "success": true,
  "subscription": {
    "id": "sub_xxx",
    "planType": "PAID_TIER_1",
    "addons": [
      {
        "type": "SCHEDULED_SENDING",
        "price": 900, // $9
        "status": "ACTIVE"
      }
    ],
    "nextBillingDate": "2025-02-01",
    "proratedAmount": 450 // í˜„ì¬ ì²­êµ¬ ì£¼ê¸°ì˜ ë‚¨ì€ ê¸°ê°„ì— ëŒ€í•œ ë¹„ë¡€ ë°°ë¶„ ê¸ˆì•¡
  }
}
```

### 2. ì• ë“œì˜¨ ì œê±°

```kotlin
DELETE /api/subscriptions/addons/:addonId

Response:
{
  "success": true,
  "subscription": { ... }
}
```

### 3. ë°œì†¡ëŸ‰ ì¡°íšŒ

```kotlin
GET /api/subscriptions/usage

Response:
{
  "currentMonth": {
    "emailCount": 1250,
    "freeLimit": 1000,
    "overLimit": 250,
    "willUpgrade": true // 1,000í†µ ì´ˆê³¼ë¡œ ìë™ ì—…ê·¸ë ˆì´ë“œ ì˜ˆì •
  },
  "subscription": {
    "planType": "FREE",
    "willUpgradeTo": "PAID_TIER_1" // ë‹¤ìŒ ì—…ê·¸ë ˆì´ë“œ ì˜ˆì • í”Œëœ
  }
}
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ì œí•œì‚¬í•­

### 1. Lemon Squeezyì˜ ì œí•œì‚¬í•­

- **Usage-based Billing**: Lemon SqueezyëŠ” Usage-based Billingì„ ì§€ì›í•˜ì§€ë§Œ, ì œí•œì ì…ë‹ˆë‹¤
- **Line Items**: Subscription ì—…ë°ì´íŠ¸ ì‹œì—ë§Œ ì¶”ê°€ ê°€ëŠ¥
- **Proration**: ìë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ì§€ë§Œ, ì •í™•í•œ ê³„ì‚°ì„ ìœ„í•´ í™•ì¸ í•„ìš”

### 2. êµ¬í˜„ ì‹œ ê³ ë ¤ì‚¬í•­

**ì• ë“œì˜¨ ì¶”ê°€:**
- ê° ì• ë“œì˜¨ì„ ë³„ë„ Product/Variantë¡œ ìƒì„±í•˜ëŠ” ê²ƒì´ ê´€ë¦¬í•˜ê¸° ì‰¬ì›€
- ë˜ëŠ” Subscription Update APIë¡œ Line Items ì¶”ê°€
- Proration ê³„ì‚°ì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ì§€ë§Œ, ì‚¬ìš©ìì—ê²Œ ëª…í™•íˆ ì•ˆë‚´ í•„ìš”

**ìë™ ì—…ê·¸ë ˆì´ë“œ:**
- ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ vs ë°°ì¹˜ ì‘ì—… ì„ íƒ
- ì‹¤ì‹œê°„: ë°œì†¡ ì¦‰ì‹œ ì²´í¬ (ì •í™•í•˜ì§€ë§Œ ë¶€í•˜ ì¦ê°€)
- ë°°ì¹˜: ë§¤ì¼/ë§¤ì‹œê°„ ì²´í¬ (ë¶€í•˜ ê°ì†Œí•˜ì§€ë§Œ ì§€ì—° ê°€ëŠ¥)
- **ê¶Œì¥**: í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ (ë°œì†¡ ì‹œ ì²´í¬ + ë§¤ì¼ ë°°ì¹˜ í™•ì¸)

### 3. ì›¹í›… ì²˜ë¦¬

```kotlin
POST /api/webhooks/lemon-squeezy

// subscription.updated ì´ë²¤íŠ¸ ì²˜ë¦¬
when (eventType) {
    "subscription.updated" -> {
        // Subscription ì •ë³´ ë™ê¸°í™”
        // ì• ë“œì˜¨ ì¶”ê°€/ì œê±° í™•ì¸
        // DB ì—…ë°ì´íŠ¸
    }
    "subscription.payment_success" -> {
        // ê²°ì œ ì„±ê³µ ì‹œ Subscription í™œì„±í™”
    }
    "subscription.payment_failure" -> {
        // ê²°ì œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
    }
}
```

---

## ğŸ’¡ ìµœì¢… ê¶Œì¥ êµ¬í˜„ ë°©ì•ˆ

### ì• ë“œì˜¨ ì¶”ê°€
âœ… **Subscription Update API ì‚¬ìš©** (Line Items ë˜ëŠ” Variant ë³€ê²½)
- ìë™ Proration ì²˜ë¦¬
- ë‹¤ìŒ ì²­êµ¬ì¼ì— ë°˜ì˜
- êµ¬í˜„ì´ ê°„ë‹¨í•¨

### Free â†’ Paid ìë™ ì „í™˜
âœ… **ë°±ì—”ë“œ ëª¨ë‹ˆí„°ë§ + Subscription Upgrade API**
- ì‹¤ì‹œê°„ ë°œì†¡ëŸ‰ ì²´í¬ (ë°œì†¡ ì‹œ)
- ë§¤ì¼ ë°°ì¹˜ í™•ì¸ (ë°±ì—…)
- 1,000í†µ ì´ˆê³¼ ì‹œ ìë™ ì—…ê·¸ë ˆì´ë“œ
- ì›¹í›…ìœ¼ë¡œ ê²°ì œ í™•ì¸

---

**ì‘ì„±ì¼**: 2025-01-15  
**ìµœì¢… ìˆ˜ì •**: 2025-01-15  
**ì°¸ê³ **: 
- [Lemon Squeezy API ë¬¸ì„œ](https://docs.lemonsqueezy.com/api)
- [Lemon Squeezy Usage-based Billing](https://docs.lemonsqueezy.com/help/products/usage-based-billing)

