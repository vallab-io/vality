# AWS SES EC2 배포 가이드

## 📋 AWS SES EC2 무료 혜택 조건

### 무료 혜택 내용

**EC2 인스턴스에서 직접 발송 시:**
- 월 **62,000건**까지 **무료** ✅
- 62,000건 초과 시: 1,000건당 **$0.10**

**일반 발송 (EC2 외부):**
- 1,000건당 **$0.10** (무료 혜택 없음)

### 중요 조건

1. **EC2 인스턴스에서 직접 발송**
   - EC2 인스턴스가 실행 중이어야 함
   - SES API를 EC2 인스턴스에서 직접 호출해야 함
   - Railway, Render, Vercel 등 PaaS에서는 **무료 혜택 불가** ❌

2. **SES Sandbox 모드 해제 필요**
   - 초기에는 Sandbox 모드 (검증된 이메일로만 발송)
   - 프로덕션 사용을 위해 Sandbox 해제 신청 필요

3. **도메인 인증 필요**
   - 발송 도메인을 SES에 인증해야 함
   - SPF, DKIM, DMARC 설정 필요

---

## 🤔 EC2 배포가 필수인가?

### 결론: **필수는 아니지만, 비용 절감을 위해 권장** ✅

### 비교 분석

#### 옵션 1: EC2 배포 (권장)

**장점:**
- ✅ 월 62,000건까지 무료 (비용 절감)
- ✅ 완전한 제어권
- ✅ 확장성 (필요 시 인스턴스 크기 조정)
- ✅ 다른 AWS 서비스와 통합 용이

**단점:**
- ❌ 초기 설정 복잡도 높음
- ❌ 서버 관리 필요 (보안 패치, 모니터링 등)
- ❌ 비용: EC2 인스턴스 비용 ($8-20/월)
- ❌ 스케일링 시 수동 관리 필요

**비용:**
- EC2 t3.micro: $8-10/월
- SES: 월 62,000건까지 무료
- **총: $8-10/월** (월 62,000건 이하)

---

#### 옵션 2: Railway/Render 배포

**장점:**
- ✅ 간편한 배포 및 관리
- ✅ 자동 스케일링
- ✅ Git 연동 자동 배포
- ✅ 초기 설정 간단

**단점:**
- ❌ SES 무료 혜택 **불가** (EC2 외부 발송)
- ❌ 비용: 1,000건당 $0.10
- ❌ 월 10,000건 발송 시 $1/월 추가 비용

**비용:**
- Railway: $5-7/월
- SES: 월 10,000건 × $0.10/1,000 = $1/월
- **총: $6-8/월** (월 10,000건 기준)

---

#### 옵션 3: 하이브리드 접근 (권장)

**구성:**
- 프론트엔드: Vercel (무료)
- 백엔드 API: Railway/Render ($5-7/월)
- 이메일 발송: EC2 Worker ($8-10/월)

**장점:**
- ✅ API 서버는 간편하게 관리 (Railway/Render)
- ✅ 이메일 발송만 EC2에서 처리 (무료 혜택)
- ✅ 관심사 분리 (API vs 이메일 발송)

**비용:**
- Railway (API): $5-7/월
- EC2 (이메일 발송): $8-10/월
- SES: 월 62,000건까지 무료
- **총: $13-17/월**

---

## 💰 비용 비교 시뮬레이션

### 시나리오 1: MVP 단계 (월 1,000건)

| 옵션 | 호스팅 비용 | SES 비용 | 총 비용 |
|------|:-----------:|:--------:|:-------:|
| EC2 배포 | $8-10 | $0 (무료) | **$8-10** |
| Railway 배포 | $5-7 | $0.10 | **$5.10-7.10** |
| 하이브리드 | $5-7 (API) + $8-10 (EC2) | $0 (무료) | **$13-17** |

**결론**: MVP 단계에서는 **Railway 배포가 더 저렴** ✅

---

### 시나리오 2: 성장 단계 (월 10,000건)

| 옵션 | 호스팅 비용 | SES 비용 | 총 비용 |
|------|:-----------:|:--------:|:-------:|
| EC2 배포 | $8-10 | $0 (무료) | **$8-10** |
| Railway 배포 | $5-7 | $1.00 | **$6-8** |
| 하이브리드 | $5-7 (API) + $8-10 (EC2) | $0 (무료) | **$13-17** |

**결론**: 성장 단계에서는 **EC2 배포가 더 저렴** ✅

---

### 시나리오 3: 대량 발송 단계 (월 100,000건)

| 옵션 | 호스팅 비용 | SES 비용 | 총 비용 |
|------|:-----------:|:--------:|:-------:|
| EC2 배포 | $8-10 | $3.80 (62,000건 무료 + 38,000건 유료) | **$11.80-13.80** |
| Railway 배포 | $5-7 | $10.00 | **$15-17** |
| 하이브리드 | $5-7 (API) + $8-10 (EC2) | $3.80 | **$16.80-20.80** |

**결론**: 대량 발송 단계에서는 **EC2 배포가 더 저렴** ✅

---

## 🎯 단계별 배포 전략

### Phase 1: MVP (초기 서비스)

**권장: Railway/Render 배포**

**이유:**
- 월 발송량이 적어서 SES 비용이 낮음 ($0.10-1/월)
- 간편한 배포 및 관리
- 빠른 개발 및 배포

**구성:**
- 프론트엔드: Vercel (무료)
- 백엔드: Railway ($5-7/월)
- SES: 일반 발송 ($0.10-1/월)
- **총: $5.10-8/월**

---

### Phase 2: 성장 단계 (월 10,000건 이상)

**권장: EC2로 마이그레이션 또는 하이브리드**

**이유:**
- 월 발송량이 증가하여 SES 비용 절감 필요
- EC2 무료 혜택 활용 (월 62,000건까지 무료)

**구성:**
- 프론트엔드: Vercel (무료)
- 백엔드: EC2 t3.micro ($8-10/월)
- SES: EC2 발송 (무료)
- **총: $8-10/월**

**또는 하이브리드:**
- 프론트엔드: Vercel (무료)
- 백엔드 API: Railway ($5-7/월)
- 이메일 Worker: EC2 ($8-10/월)
- SES: EC2 발송 (무료)
- **총: $13-17/월**

---

### Phase 3: 대량 발송 단계 (월 100,000건 이상)

**권장: EC2 배포 (필수)**

**이유:**
- 대량 발송 시 SES 비용이 크게 증가
- EC2 무료 혜택으로 비용 절감 (월 62,000건까지 무료)

**구성:**
- 프론트엔드: Vercel (무료 또는 Pro $20/월)
- 백엔드: EC2 t3.small ($15-20/월)
- SES: EC2 발송 ($3.80-43.80/월)
- **총: $18.80-63.80/월**

---

## 🔧 EC2 배포 구현 방법

### 1. EC2 인스턴스 생성

```bash
# t3.micro 인스턴스 (Free Tier 가능)
- 인스턴스 타입: t3.micro (1 vCPU, 1GB RAM)
- AMI: Ubuntu 22.04 LTS
- 스토리지: 20GB gp3
- 보안 그룹: HTTP (80), HTTPS (443), SSH (22)
```

### 2. Docker 설치 및 애플리케이션 배포

```bash
# EC2 인스턴스에 접속
ssh -i your-key.pem ubuntu@your-ec2-ip

# Docker 설치
sudo apt update
sudo apt install docker.io docker-compose

# 애플리케이션 배포
git clone your-repo
cd vality
docker-compose up -d
```

### 3. AWS SES 설정

```bash
# SES 도메인 인증
aws ses verify-domain-identity --domain yourdomain.com

# SPF, DKIM, DMARC 설정 (DNS)
# SES 콘솔에서 제공하는 레코드를 DNS에 추가
```

### 4. 이메일 발송 코드 (Kotlin)

```kotlin
// EC2에서 SES API 직접 호출
val sesClient = SesClient.builder()
    .region(Region.AP_NORTHEAST_2)
    .build()

suspend fun sendEmail(to: String, subject: String, body: String) {
    val request = SendEmailRequest.builder()
        .source("noreply@yourdomain.com")
        .destination(Destination.builder().toAddresses(to).build())
        .message(Message.builder()
            .subject(Content.builder().data(subject).build())
            .body(Body.builder().html(Content.builder().data(body).build()).build())
            .build())
        .build()
    
    sesClient.sendEmail(request)
}
```

---

## ⚠️ 주의사항

### 1. SES Sandbox 모드

- 초기에는 Sandbox 모드 (검증된 이메일로만 발송)
- 프로덕션 사용을 위해 Sandbox 해제 신청 필요
- 신청 시 사용 사례 설명 필요

### 2. 발송 제한

- **신규 계정**: 24시간에 200통, 초당 1통
- **Sandbox 해제 후**: 점진적으로 증가
- **프로덕션**: 필요 시 한도 증가 요청

### 3. 반송률 관리

- 반송률 5% 초과 시 계정 일시 정지 가능
- 불량 이메일 주소 정기 정리 필요
- 구독 취소 요청 즉시 처리

---

## 📊 최종 권장 사항

### 단계별 접근

1. **MVP 단계**: Railway/Render 배포 (간편함 우선)
2. **성장 단계**: EC2로 마이그레이션 (비용 절감)
3. **대량 발송 단계**: EC2 필수 (비용 효율)

### 하이브리드 접근 (최적)

- **API 서버**: Railway/Render (간편한 관리)
- **이메일 Worker**: EC2 (SES 무료 혜택)
- **장점**: 관심사 분리, 비용 절감, 관리 편의성

---

## ✅ 결론

**EC2 배포가 필수는 아니지만, 비용 절감을 위해 권장됩니다.**

**권장 시나리오:**
- **초기 (MVP)**: Railway/Render 배포 (간편함)
- **성장 단계**: EC2로 마이그레이션 (비용 절감)
- **대량 발송**: EC2 필수 (비용 효율)

**또는 하이브리드:**
- API 서버는 Railway/Render 유지
- 이메일 발송만 EC2 Worker로 분리
- 최적의 비용 효율과 관리 편의성 달성

---

**작성일**: 2025-01-15  
**최종 수정**: 2025-01-15

